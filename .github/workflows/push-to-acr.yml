name: Push to ACR

on:
  workflow_dispatch:

env:
  ACR_NAME: ${{ secrets.ACR_NAME }}

jobs:
  push:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Login to ACR
      run: |
        az acr login --name ${{ env.ACR_NAME }}
    
    - name: Build and Push Airflow
      run: |
        docker build -t ${{ env.ACR_NAME }}.azurecr.io/airflow:latest -f airflow/Dockerfile ./airflow
        docker push ${{ env.ACR_NAME }}.azurecr.io/airflow:latest
    
    - name: Build and Push DBT
      run: |
        docker build -t ${{ env.ACR_NAME }}.azurecr.io/dbt:latest -f dbt/Dockerfile ./dbt
        docker push ${{ env.ACR_NAME }}.azurecr.io/dbt:latest
    
    - name: Restart ACI Containers
      run: |
        echo "Restarting Airflow containers..."
        az container restart \
          --name aci-scheduler3 \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --no-wait
        
        az container restart \
          --name aci-webserver3 \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --no-wait
        
        echo "âœ… Containers restarting (takes 1-2 minutes to pull new images)"
    
    - name: Deployment Summary
      run: |
        echo "### ðŸš€ Deployment Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Images pushed to ACR:**" >> $GITHUB_STEP_SUMMARY
        echo "- airflow:latest" >> $GITHUB_STEP_SUMMARY
        echo "- dbt:latest" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Containers restarted:**" >> $GITHUB_STEP_SUMMARY
        echo "- aci-scheduler" >> $GITHUB_STEP_SUMMARY
        echo "- aci-webserver" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Wait 1-2 minutes, then refresh Airflow UI to see changes." >> $GITHUB_STEP_SUMMARY
